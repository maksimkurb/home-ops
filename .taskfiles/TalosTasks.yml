---
version: "3"

env:
  USERNAME: maksimkurb
  REGISTRY: docker.io
  TAG: v1.4.1-nvidia
  PKGS_REF: 988f1ecf95536fb259cbd79e044a556728bc7332

tasks:

  genconfig:
    desc: Generate Talos config
    dir: talos
    cmds:
      - talhelper genconfig

  apply:
    desc: Apply Talos config
    dir: talos
    cmds:
      - talosctl apply-config -f clusterconfig/home-cluster-k8s-master.yaml --nodes 192.168.42.101 {{.CLI_ARGS}}
      - talosctl apply-config -f clusterconfig/home-cluster-k8s-worker1.yaml --nodes 192.168.42.102 {{.CLI_ARGS}}
      - talosctl apply-config -f clusterconfig/home-cluster-k8s-worker2.yaml --nodes 192.168.42.103 {{.CLI_ARGS}}

  bootstrap:
    desc: Apply Talos config
    dir: talos
    cmds:
      - talosctl bootstrap --nodes k8s-master

  cni:
    desc: Apply CNI config
    dir: talos
    cmds:
      - kubectl kustomize --enable-helm ./cni/ | kubectl apply -f -

  nvidia:build:kernel:
    desc: Build NVidia kernel modules
    dir: .
    cmds:
      - "[ -d talos/pkgs ] || git clone https://github.com/siderolabs/pkgs.git talos/pkgs"
      - cd talos/pkgs && git checkout $PKGS_REF && make kernel nonfree-kmod-nvidia PLATFORM=linux/amd64 PUSH=true

  nvidia:build:installer:
    desc: Build NVidia Talos installer
    dir: .
    cmds:
      - docker pull $REGISTRY/$USERNAME/nonfree-kmod-nvidia:$TAG
      - cd talos/nvidia && DOCKER_BUILDKIT=0 docker build --squash --build-arg RM="/lib/modules" -t $REGISTRY/$USERNAME/installer:$TAG .
      - docker push $REGISTRY/$USERNAME/installer:$TAG

  nvidia:install:
    desc: Install NVidia on node
    dir: talos
    cmds:
      - talosctl --nodes 192.168.42.103 upgrade --image=$REGISTRY/$USERNAME/installer:$TAG
