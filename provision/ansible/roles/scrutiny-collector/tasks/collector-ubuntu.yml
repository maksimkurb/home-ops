---
- name: Install required packages for scrutiny-collector
  ansible.builtin.apt:
    name:
      - smartmontools
      - curl
      - cron
    state: present
    update_cache: true
  become: true

- name: Create scrutiny directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: root
    group: root
    mode: "0755"
  loop:
    - "{{ scrutiny_collector_install_dir }}"
    - "{{ scrutiny_collector_config_dir }}"
  become: true

- name: Check if scrutiny-collector binary exists
  ansible.builtin.stat:
    path: "{{ scrutiny_collector_install_dir }}/scrutiny-collector-metrics"
  register: scrutiny_binary

- name: Get current scrutiny-collector version
  ansible.builtin.command:
    cmd: "{{ scrutiny_collector_install_dir }}/scrutiny-collector-metrics --version"
  register: current_version
  when: scrutiny_binary.stat.exists
  changed_when: false
  failed_when: false

- name: Download scrutiny-collector binary
  ansible.builtin.get_url:
    url: "https://github.com/AnalogJ/scrutiny/releases/download/{{ scrutiny_collector_version }}/scrutiny-collector-metrics-linux-{{ 'amd64' if ansible_architecture == 'x86_64' else ansible_architecture }}"
    dest: "{{ scrutiny_collector_install_dir }}/scrutiny-collector-metrics"
    owner: root
    group: root
    mode: "0755"
    force: true
  become: true
  when: not scrutiny_binary.stat.exists or (current_version.stdout is defined and scrutiny_collector_version not in current_version.stdout)

- name: Deploy scrutiny-collector configuration
  ansible.builtin.template:
    src: collector.yaml.j2
    dest: "{{ scrutiny_collector_config_dir }}/collector.yaml"
    owner: root
    group: root
    mode: "0644"
  become: true

- name: Create cron job for scrutiny-collector
  ansible.builtin.cron:
    name: "scrutiny-collector metrics"
    minute: "{{ scrutiny_collector_cron_minute }}"
    hour: "{{ scrutiny_collector_cron_hour }}"
    day: "{{ scrutiny_collector_cron_day }}"
    month: "{{ scrutiny_collector_cron_month }}"
    weekday: "{{ scrutiny_collector_cron_weekday }}"
    job: "{{ scrutiny_collector_install_dir }}/scrutiny-collector-metrics run --config {{ scrutiny_collector_config_dir }}/collector.yaml >> /var/log/scrutiny-collector.log 2>&1"
    user: root
    cron_file: scrutiny-collector
    state: present
  become: true
