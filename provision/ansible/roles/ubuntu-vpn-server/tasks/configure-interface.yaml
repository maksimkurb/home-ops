---

- name: Clear resolved peers from previous iteration
  set_fact:
    resolved_peers: []

- name: Set interface facts
  set_fact:
    interface: "{{ item.value }}"
    interface_name: "{{ item.key }}"

- name: Set default mode to server if not specified
  set_fact:
    interface: "{{ interface | combine({'mode': 'server'}) }}"
  when: interface.mode is not defined

- name: Set default private_interface if not specified
  set_fact:
    interface: "{{ interface | combine({'private_interface': interface_name}) }}"
  when: interface.private_interface is not defined

- name: Resolve peer references from client registry
  include_tasks: resolve-peers.yaml
  when: interface.mode == 'server'

- name: Update interface with resolved peers
  set_fact:
    interface: "{{ interface | combine({'peers': resolved_peers}) }}"
  when:
    - interface.mode == 'server'
    - resolved_peers is defined

- name: Determine public interface for {{ interface_name }}
  set_fact:
    awg_public_interface: "{{ interface.public_interface | default(vpn_wan_interface, true) if (interface.public_interface | default('')) != '' else vpn_wan_interface }}"

- name: Fail if public interface is not defined for {{ interface_name }}
  fail:
    msg: "Public interface is not defined. Please set either interface.public_interface or vpn_wan_interface variable."
  when: awg_public_interface is not defined or awg_public_interface == '' or awg_public_interface is none

- name: Check if public interface {{ awg_public_interface }} exists
  ansible.builtin.stat:
    path: "/sys/class/net/{{ awg_public_interface }}"
  register: public_interface_check
  become: true

- name: Fail if public interface does not exist
  fail:
    msg: "Public interface '{{ awg_public_interface }}' does not exist on {{ inventory_hostname }}. Available interfaces: {{ ansible_interfaces | join(', ') }}"
  when: not public_interface_check.stat.exists

- name: Validate server mode configuration for {{ interface_name }}
  fail:
    msg: "Server mode requires 'port' and 'public_host' to be defined"
  when:
    - interface.mode == 'server'
    - (interface.port is not defined or interface.public_host is not defined)

- name: Validate client mode configuration for {{ interface_name }}
  fail:
    msg: "Client mode requires 'remote_endpoint' and 'remote_public_key' to be defined"
  when:
    - interface.mode == 'client'
    - (interface.remote_endpoint is not defined or interface.remote_public_key is not defined)

- name: Configure AmneziaWG for {{ interface_name }}
  template:
    src: awg.conf.j2
    dest: "/etc/amnezia/amneziawg/{{ interface_name }}.conf"
    owner: root
    group: root
    mode: '0600'
  become: true
  register: config_changed

- name: Restart AmneziaWG service for {{ interface_name }} if config changed
  systemd:
    name: "awg-quick@{{ interface_name }}"
    state: restarted
  become: true
  when: config_changed.changed

- name: Enable AmneziaWG service for {{ interface_name }}
  systemd:
    name: "awg-quick@{{ interface_name }}"
    enabled: yes
  become: true

- name: Start AmneziaWG service for {{ interface_name }} if not running
  systemd:
    name: "awg-quick@{{ interface_name }}"
    state: started
  become: true

- name: Generate client configs (server mode only)
  delegate_to: localhost
  become: false
  template:
    src: awg-client.conf.j2
    dest: "{{ repo_abs_path.stdout }}/provision/vpn-server-awg-configs/{{ inventory_hostname }}/{{ peer.name }}.conf"
    mode: '0600'
  loop: "{{ interface.peers }}"
  loop_control:
    loop_var: peer
    label: "{{ peer.name }}"
  when:
    - interface.mode == 'server'
    - interface.peers is defined
    - interface.peers | length > 0
