---
- name: Get absolute path to this Git repository
  delegate_to: localhost
  become: false
  run_once: true
  ansible.builtin.command: "git rev-parse --show-toplevel"
  register: repo_abs_path

- name: Create directory for client configs
  delegate_to: localhost
  become: false
  ansible.builtin.file:
    path: "{{ repo_abs_path.stdout }}/provision/vpn-server-awg-configs/{{ inventory_hostname }}"
    state: directory
    mode: '0700'

- name: Merge group and host level interface configurations
  set_fact:
    merged_amneziawg_interfaces: "{{ amneziawg_interfaces_group | default({}) | combine(amneziawg_interfaces_host | default({}), recursive=True) }}"
  when: amneziawg_interfaces_group is defined or amneziawg_interfaces_host is defined

- name: Use direct amneziawg_interfaces if group/host split not used
  set_fact:
    merged_amneziawg_interfaces: "{{ amneziawg_interfaces }}"
  when:
    - amneziawg_interfaces is defined
    - amneziawg_interfaces_group is not defined
    - amneziawg_interfaces_host is not defined

- name: Fail if no interfaces are defined
  fail:
    msg: "No AmneziaWG interfaces defined. Please define amneziawg_interfaces, or amneziawg_interfaces_group/amneziawg_interfaces_host"
  when: merged_amneziawg_interfaces is not defined or merged_amneziawg_interfaces | length == 0

- name: Configure persistent routing tables
  include_tasks: configure-routing-tables.yaml

- name: Configure AmneziaWG for each interface
  include_tasks: configure-interface.yaml
  loop: "{{ merged_amneziawg_interfaces | dict2items }}"
  loop_control:
    loop_var: item
  no_log: true
