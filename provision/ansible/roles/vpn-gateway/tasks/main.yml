- name: Adding singbox repository
  block:
    - name: Downloading singbox gpg key
      ansible.builtin.get_url:
        url: https://sing-box.app/gpg.key
        dest: /etc/apt/keyrings/sagernet.asc
        mode: "0644"

    - name: Add singbox repo
      ansible.builtin.apt_repository:
        repo: "deb [arch=amd64 signed-by=/etc/apt/keyrings/sagernet.asc] https://deb.sagernet.org/ * *"
        filename: sagernet.list
        state: present

- name: Installing singbox and nftables
  ansible.builtin.apt:
    name:
      - sing-box
      - nftables
    state: present

- name: Updating singbox config
  ansible.builtin.template:
    src: config.json.jinja
    dest: "/etc/sing-box/config.json"
    mode: "0644"

- name: Enabling and starting singbox.service
  ansible.builtin.systemd_service:
    state: restarted
    daemon_reload: true
    name: sing-box
    enabled: true

- name: Updating nftables config
  ansible.builtin.template:
    src: nftables.conf.jinja
    dest: "/etc/nftables.conf"
    mode: "0644"

- name: Enabling and starting nftables.service
  ansible.builtin.systemd_service:
    state: restarted
    daemon_reload: true
    name: nftables
    enabled: true

# - name: Customizing /etc/environment
#   ansible.builtin.lineinfile:
#     dest: "/etc/environment"
#     state: present
#     regexp: "^{{ item.key }}="
#     line: "{{ item.key }}={{ item.value }}"
#   with_items: "{{ os_environment }}"
