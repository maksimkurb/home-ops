---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: victoria-metrics
  namespace: monitoring
spec:
  interval: 30m
  chart:
    spec:
      chart: victoria-metrics-k8s-stack
      version: 0.19.1
      sourceRef:
        kind: HelmRepository
        name: victoria-metrics-k8s-stack-charts
        namespace: flux-system
  install:
    createNamespace: true
    remediation:
      retries: 3
  upgrade:
    remediation:
      retries: 3
  values:
    grafana:
      enabled: false
    fullnameOverride: "vm-k8s-stack"
    vmagent:
      spec:
        externalLabels:
          cluster: cluster-name
        scrapeInterval: 60s
      ingress:
        enabled: true
        ingressClassName: "nginx"
        annotations:
          nginx.ingress.kubernetes.io/whitelist-source-range: 10.0.0.0/8,172.16.0.0/12,192.168.0.0/16
        hosts:
          - &vmagent-host "vmagent.${SECRET_DOMAIN}"
        tls:
          - hosts:
              - *vmagent-host
    vmsingle:
      spec:
        storage:
          storageClassName: "nfs-proxmox"
          resources:
            requests:
              storage: 30Gi
      ingress:
        enabled: true
        ingressClassName: "nginx"
        annotations:
          nginx.ingress.kubernetes.io/whitelist-source-range: 10.0.0.0/8,172.16.0.0/12,192.168.0.0/16
        hosts:
          - &vmsingle-host "vmsingle.${SECRET_DOMAIN}"
        tls:
          - hosts:
              - *vmsingle-host
    prometheus-node-exporter:
      enabled: false
    kubelet:
      spec:
        scheme: "https"
        honorLabels: true
        interval: "60s"
        scrapeTimeout: "5s"
        tlsConfig:
          insecureSkipVerify: true
          caFile: "/var/run/secrets/kubernetes.io/serviceaccount/ca.crt"
        bearerTokenFile: "/var/run/secrets/kubernetes.io/serviceaccount/token"
        # drop high cardinality label and useless metrics for cadvisor and kubelet
        metricRelabelConfigs:
          - action: labeldrop
            regex: (uid)
          - action: labeldrop
            regex: (id|name)
          - action: drop
            source_labels: [__name__]
            regex: (rest_client_request_duration_seconds_bucket|rest_client_request_duration_seconds_sum|rest_client_request_duration_seconds_count)
        relabelConfigs:
          - action: labelmap
            regex: __meta_kubernetes_node_label_(.+)
          - sourceLabels: [__metrics_path__]
            targetLabel: metrics_path
          - targetLabel: "job"
            replacement: "kubelet"
          - targetLabel: "cluster"
            replacement: "cluster-name"
    alertmanager:
      config:
        inhibit_rules:
          - source_matchers:
              - severity = "critical"
            target_matchers:
              - severity = "warning"
            equal: ["alertname", "namespace"]
        route:
          group_by: ['alertname', 'job']
          group_wait: 30s
          group_interval: 5m
          repeat_interval: 6h
          receiver: discord
          routes:
            - receiver: "null"
              matchers:
                - alertname =~ "InfoInhibitor|Watchdog"
            - receiver: "discord"
              continue: true
              matchers:
                - severity = "critical"
        receivers:
          - name: "null"
          - name: "discord"
            discord_configs:
              - webhook_url: "${SECRET_ALERT_MANAGER_DISCORD_WEBHOOK}"
      ingress:
        enabled: true
        ingressClassName: "nginx"
        annotations:
          nginx.ingress.kubernetes.io/whitelist-source-range: 10.0.0.0/8,172.16.0.0/12,192.168.0.0/16
        hosts:
          - &vmalertmanager-host "vmalertmanager.${SECRET_DOMAIN}"
        tls:
          - hosts:
              - *vmalertmanager-host
