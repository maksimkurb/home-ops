---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: keycloak
  namespace: default
spec:
  interval: 5m
  chart:
    spec:
      # renovate: registryUrl=https://charts.bitnami.com/bitnami
      chart: keycloak
      version: 9.8.1
      sourceRef:
        kind: HelmRepository
        name: bitnami-charts
        namespace: flux-system
      interval: 5m
  values:
    image:
      repository: bitnami/keycloak
      tag: 20.0.1
    ingress:
      enabled: true
      ingressClassName: "traefik"
      annotations:
        cert-manager.io/cluster-issuer: "letsencrypt-production"
        external-dns/is-public: "true"
        external-dns.alpha.kubernetes.io/target: "ipv4.${SECRET_DOMAIN}"
        traefik.ingress.kubernetes.io/router.entrypoints: "websecure"
        hajimari.io/appName: "Keycloak (SSO)"
        hajimari.io/enable: "true"
        hajimari.io/icon: "account-key"
        hajimari.io/group: "Personal services"
      hostname: login.${SECRET_DOMAIN}
      tls: true

    auth:
      createAdminUser: true
      adminUser: keycloak-admin
      managementUser: keycloak-manager
      existingSecretPerPassword:
        keyMapping:
          adminPassword: adminPassword
          managementPassword: managementPassword
          databasePassword: databasePassword
          tlsKeystorePassword: tlsKeystyrePassword
          tlsTruststorePassword: tlsTruststorePassword
        adminPassword:
          name: keycloak-credentials
        managementPassword:
          name: keycloak-credentials
        databasePassword:
          name: keycloak-credentials
        tlsKeystorePassword:
          name: keycloak-credentials
        tlsTruststorePassword:
          name: keycloak-credentials
    proxyAddressForwarding: true

    metrics:
      enabled: false

    postgresql:
      enabled: false

    externalDatabase:
      host: homelab-pgsql.database.svc.cluster.local
      user: keycloak
      database: keycloak
      existingSecret: keycloak-credentials
      existingSecretPasswordKey: databasePassword

    resources:
      requests:
        memory: 384Mi
      limits:
        memory: 1G
